
// common.js
const jsTools = {
    getNumber: function (str) {
        return parseInt(str.replace(/\s/g, ''));
    },
    getWindowWidth: function () {
        return document.documentElement.clientWidth;
    },
    getNumberFormat: function (number, decimals, dec_point, thousands_sep) {
        var i, j, kw, kd, km;
        if (isNaN(decimals = Math.abs(decimals))) {
            decimals = 2;
        }
        if (dec_point == undefined) {
            dec_point = ",";
        }
        if (thousands_sep == undefined) {
            thousands_sep = ".";
        }
        i = parseInt(number = (+number || 0).toFixed(decimals)) + "";
        if ((j = i.length) > 3) {
            j = j % 3;
        } else {
            j = 0;
        }
        km = (j ? i.substr(0, j) + thousands_sep : "");
        kw = i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thousands_sep);
        kd = (decimals ? dec_point + Math.abs(number - i).toFixed(decimals).replace(/-/, 0).slice(2) : "");
        return km + kw + kd;
    },
    imagesResize: function (src) {
        let img = document.querySelectorAll('img');

        for (let i=0;i<img.length;i++){
            img[i].src = src;
        }
    }
};
function Popup() {
    let popup = this,
        modal = document.createElement('div'),
        wrap = document.createElement('div'),
        form = document.createElement('div'),
        close = document.createElement('button');

    close.innerHTML = '<svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M0.43934 0.43934C-0.146447 1.02513 -0.146447 1.97487 0.43934 2.56066L15.4393 17.5607C16.0251 18.1464 16.9749 18.1464 17.5607 17.5607C18.1464 16.9749 18.1464 16.0251 17.5607 15.4393L2.56066 0.43934C1.97487 -0.146447 1.02513 -0.146447 0.43934 0.43934Z" fill="#DADADA"/><path fill-rule="evenodd" clip-rule="evenodd" d="M17.5607 0.43934C18.1464 1.02513 18.1464 1.97487 17.5607 2.56066L2.56066 17.5607C1.97487 18.1464 1.02513 18.1464 0.43934 17.5607C-0.146446 16.9749 -0.146446 16.0251 0.43934 15.4393L15.4393 0.43934C16.0251 -0.146447 16.9749 -0.146447 17.5607 0.43934Z" fill="#DADADA"/></svg>';

    // adds class
    close.classList.add('popup__close');
    form.classList.add('popup__form');
    wrap.classList.add('popup__wrap');
    modal.classList.add('popup');

    // appends
    wrap.append(close);
    wrap.append(form);
    modal.append(wrap);
    document.body.append(modal);

    this.open = function (content) {
        let html = getHtml(content);
        form.innerHTML = html;
        modal.classList.add('active');
        popup.setOverflow();
    };

    this.close = function () {
        form.innerHTML = '';
        modal.classList.remove('active');
        popup.removeOverflow();
    };

    this.setOverflow = function (){
        document.body.classList.add('ovh');
    }

    this.removeOverflow = function (){
        document.body.classList.remove('ovh');
    }

    function getHtml(content){
        let type = typeof content;

        if (type=='string'){
            return content;
        } else {
            return content.outerHTML;
        }
    }

    modal.addEventListener('click', function (e){
        if (!e.target.closest('.popup__wrap')){
            popup.close();
        }
    });
    close.addEventListener('click', popup.close);
}

function Template(settings,current){
    let tmpl = this;
    if (settings.parent){
        let parent = current.closest(settings.parent);
        this.template = parent.querySelector(settings.template).content;
    } else{
        this.template = document.querySelector(settings.template).content;
    }
    this.content = this.template.querySelector(settings.content);

    this.html = function (){
        return tmpl.content.outerHTML;
    }
}

//index.js
(function () {

    $('input[type=tel]').mask('+7 (999) 999-99-99');

    //TABS
    let $jsTabs = $('.jsTabs');

    $jsTabs.each(function (x, i) {
        let $jsTab = $(i),
            $tabs = $jsTab.find('.jsTab'),
            $swsList = $jsTab.find('.jsSws'),
            $sws = $swsList.find('.jsSw');

        $sws.on('click', function (e) {
            let sw = $(this),
                index = $sws.index(sw),
                tab = $($tabs[index]);

            if(sw.hasClass('active')){
                $swsList.toggleClass('open');
            } else{
                $swsList.removeClass('open');
            }
            $sws.removeClass('active');
            $tabs.removeClass('active');
            sw.addClass('active');
            tab.addClass('active');

        });

    });



    //FAQ
    let faqs = $('.jsFaq');

    faqs.on('click', function (e){
        $this = $(this);
       faqs.not($this).removeClass('active');
        $this.toggleClass('active');
    });

    $(window).on('click', function (e){
       let target = e.target;

       if(!target.closest('.faq__item')){
           faqs.removeClass('active');
       }
    });


    //SWIPERS
    const swiperPrice = new Swiper('.price__container', {
        slidesPerView: '1',
        spaceBetween: 20,
        watchSlidesVisibility: true,
        allowTouchMove: false,
        slideVisibleClass: 'pslide_visible',
        // Navigation arrows
        navigation: {
            nextEl: '.price__next',
            prevEl: '.price__prev',
        },
        on: {
            init: function (event, args) {
                let arr = this.slides.filter(i => i.classList.contains('pslide_visible'));
                syncSliderPrice(arr);
            },
            slideChange: function () {
                let arr = this.slides.filter(i => i.classList.contains('pslide_visible'));
                syncSliderPrice(arr);
            },
        },
        breakpoints: {
            // when window width is >= 768px
            768: {
                slidesPerView: 2,
                spaceBetween: 20,
                allowTouchMove: true,
            },
            // when window width is >= 480px
            1200: {
                slidesPerView: '3',
                spaceBetween: 20,
                allowTouchMove: true,
            },
        }
    });

    window.swiperPrice = swiperPrice;

    let pcomp = $('.pcomp'),
        pcompSw = pcomp.find('.pcomp__item');

    pcompSw.on('click', function (e) {
        let sw = $(this);

        if(sw.hasClass('active')){
            pcomp.toggleClass('open');
        } else{
            pcomp.removeClass('open');
        }

        swiperPrice.slideTo(this.dataset.id);
    });


    const resultsSwiperThumbs = new Swiper('.rthumbs__container', {
        spaceBetween: 10,
        slidesPerView: 2.5,
        watchSlidesVisibility: true,
        breakpoints: {
            // when window width is >= 768px
            768: {
                slidesPerView: 4,
                spaceBetween: 20
            },
            // when window width is >= 480px
            1200: {
                slidesPerView: 6,
                spaceBetween: 20,
            },
        }
    });

    const resultsSwiper = new Swiper('.rslider', {
        spaceBetween: 40,
        effect: 'fade',
        navigation: {
            nextEl: '.rthumbs__next',
            prevEl: '.rthumbs__prev',
        },
        thumbs: {
            swiper: resultsSwiperThumbs
        },
    });

    const dsliders = document.querySelectorAll('.dslider');

    dsliders.forEach(function (dslider,index) {

        new Swiper(dslider, {
            navigation: {
                nextEl: '.dslider_'+(index+1)+' .dslider__next',
                prevEl: '.dslider_'+(index+1)+' .dslider__prev'
            },
        });
    });

    const revsSwiper = new Swiper('.revs__container', {
        spaceBetween: 10,
        navigation: {
            nextEl: '.revs__next',
            prevEl: '.revs__prev',
        },
    });

    const weSwiper = new Swiper('.we__container', {
        loop: true,
        slidesPerView: 1.5,
        autoplay: {
            delay: 5000,
        },
        breakpoints: {
            // when window width is >= 768px
            768: {
                slidesPerView: 2.5,
            },
            // when window width is >= 480px
            1200: {
                slidesPerView: 4,
            },
        }
    });


    //TIPPY
    tippy(document.querySelectorAll('.how .jsTippy'),
        {
            content: (reference) => reference.getAttribute('title'),
            trigger: 'click',
            theme: 'light',
        });

    //FUNCTIONS
    function syncSliderPrice(arr) {
        $('.pcomp__item').removeClass('active');

        arr.forEach(function (item) {
            $('.pcomp__item[data-id=' + item.dataset.id + ']').addClass('active');
        });


    }

    function setDocsHeight(){
        let $tabs = $('.docs__tab');
        let maxHeight = 0;
        $tabs.each(function (x,i){
            let h =$(i).outerHeight();
            if(maxHeight<h){
                maxHeight = h;
            }
        });

        $('.docs__items').css('height', maxHeight+'px');

    }

    setDocsHeight();

    //POPUP
    let popup = new Popup();
    $('.jsCall').on('click', function (e){

        let data = {
            template: '.template',
            content: '.callorder'
        }

        let html = new Template(data, this).html();
        popup.open(html);

        $(data.content).validate({
            onfocusout: false,
            submitHandler: function (form) {
                $(form).find('.form__error').removeClass('active');

                let data = $(form).serialize(),
                    url = $(form).attr('action');

                $.ajax({
                    dataType: "json",
                    type: "POST",
                    url: url,
                    data: data,
                    success: function (result) {
                        if (result.status) {
                            $(form).append(new Template({
                                template: '.template',
                                content: '.success'
                            }).html());
                        } else {
                            alert('Что-то пошло не так, попробуйте еще раз!!!');
                        }
                    },
                    error: function (result) {
                        alert('Что-то пошло не так, попробуйте еще раз!!!');
                    }
                });


            },
            invalidHandler: function (event, validator) {
                $(this).find('.form__error').addClass('active');
            },
        });
        $('input[type=tel]').mask('+7 (999) 999-99-99');

    });

    $('.what__form').validate({
        onfocusout: false,
        submitHandler: function (form) {
            let data = $(form).serialize(),
                url = $(form).attr('action');

            $.ajax({
                dataType: "json",
                type: "POST",
                url: url,
                data: data,
                success: function (result) {
                    if (result.status) {

                        let data = {
                            template: '.template',
                            content: '.success'
                        }
                        let html = new Template(data, this).html();
                        popup.open(html);
                    } else {
                        alert('Что-то пошло не так, попробуйте еще раз!!!');
                    }
                },
                error: function (result) {
                    alert('Что-то пошло не так, попробуйте еще раз!!!');
                }
            });


        },
        invalidHandler: function (event, validator) {
            $(this).find('.form__error').addClass('active');
        },
    });

    //SELECT


}());